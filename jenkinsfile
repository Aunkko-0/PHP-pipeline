pipeline {
    agent any

    environment {
        IMAGE_NAME = "my-php-app"
        CONTAINER_NAME = "php-container"
        PORT_MAPPING = "8080:80" // เข้าผ่าน port 8080
    }

    stages {
        stage('Prepare File') {
            steps {
                script {
                    // จำลองสร้างไฟล์ PHP และ Dockerfile (ในการใช้งานจริงควรดึงจาก Git)
                    sh 'mkdir -p src'
                    sh 'echo "<?php echo \"Hello PHP via Jenkins\"; ?>" > src/index.php'
                    
                    // เขียน Dockerfile สำหรับ PHP
                    sh """
                        echo 'FROM php:8.1-apache' > Dockerfile
                        echo 'COPY src/ /var/www/html/' >> Dockerfile
                    """
                }
            }
        }

        stage('Build') {
            steps {
                // สร้าง Image
                sh "docker build -t ${IMAGE_NAME}:latest ."
            }
        }

        stage('Deploy') {
            steps {
                script {
                    // Cleanup และ Run ใหม่
                    sh "docker stop ${CONTAINER_NAME} || true"
                    sh "docker rm ${CONTAINER_NAME} || true"
                    sh "docker run -d --name ${CONTAINER_NAME} -p ${PORT_MAPPING} ${IMAGE_NAME}:latest"
                }
            }
        }
    }
}