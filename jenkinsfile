pipeline {
    agent any

    environment {
        // --- 1. à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ (à¹à¸à¹‰à¹„à¸‚à¸•à¸£à¸‡à¸™à¸µà¹‰) ---
        REMOTE_USER    = 'tanapol'              // User à¸‚à¸­à¸‡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ Server (à¹€à¸Šà¹ˆà¸™ root, ubuntu)
        REMOTE_HOST    = '192.168.1.156'        // IP à¸‚à¸­à¸‡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ Server (à¸”à¸¹à¸§à¸´à¸˜à¸µà¸«à¸² IP à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡)
        SSH_CREDS_ID   = 'server-ssh-key'    // ID à¸‚à¸­à¸‡ SSH Key à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸•à¸±à¹‰à¸‡à¹ƒà¸™ Jenkins Credentials
        
        // --- 2. à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹‚à¸›à¸£à¹€à¸ˆà¸„ ---
        PROJECT_DIR    = 'index.php' // à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¸—à¸µà¹ˆà¸ˆà¸°à¸§à¸²à¸‡à¸‡à¸²à¸™à¸šà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ Server
        GIT_REPO_URL   = 'https://github.com/Aunkko-0/PHP-pipeline.git' // à¸¥à¸´à¸‡à¸à¹Œ Git
        BRANCH_NAME    = 'main'                // Branch à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£ Deploy
    }

    stages {
        stage('Deploy to Server') {
            steps {
                // à¹ƒà¸Šà¹‰ plugin ssh-agent à¹€à¸žà¸·à¹ˆà¸­à¹‚à¸«à¸¥à¸” Private Key à¸¡à¸²à¹ƒà¸Šà¹‰à¸Šà¸±à¹ˆà¸§à¸„à¸£à¸²à¸§
                sshagent(credentials: [SSH_CREDS_ID]) {
                    script {
                        echo "ðŸš€ Connecting to ${REMOTE_HOST}..."
                        
                        // à¹€à¸£à¸´à¹ˆà¸¡à¸ªà¹ˆà¸‡à¸„à¸³à¸ªà¸±à¹ˆà¸‡ SSH à¹„à¸›à¸—à¸³à¸‡à¸²à¸™à¸—à¸µà¹ˆà¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡
                        // -o StrictHostKeyChecking=no à¹€à¸žà¸·à¹ˆà¸­à¸‚à¹‰à¸²à¸¡à¸à¸²à¸£à¸–à¸²à¸¡à¸¢à¸·à¸™à¸¢à¸±à¸™ fingerprint
                        sh """
                            ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} '
                                
                                # à¸«à¸¢à¸¸à¸”à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸ˆà¸­ Error
                                set -e
                                
                                echo "ðŸ“‚ Preparing directory..."
                                mkdir -p ${PROJECT_DIR}
                                cd ${PROJECT_DIR}

                                # --- Step 1: à¸”à¸¶à¸‡à¹‚à¸„à¹‰à¸” (Git Clone/Pull) ---
                                if [ -d ".git" ]; then
                                    echo "ðŸ”„ Updating code..."
                                    git fetch origin
                                    git reset --hard origin/${BRANCH_NAME}
                                else
                                    echo "â¬‡ï¸ Cloning repository..."
                                    git clone -b ${BRANCH_NAME} ${GIT_REPO_URL} .
                                fi

                                # --- Step 2: à¸ˆà¸±à¸”à¸à¸²à¸£ Config (à¸ªà¸³à¸«à¸£à¸±à¸š Laravel) ---
                                # à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ .env à¹ƒà¸«à¹‰ copy à¸ˆà¸²à¸ .env.example
                                if [ ! -f .env ]; then
                                    cp .env.example .env
                                    # (Optional) à¹à¸à¹‰à¸„à¹ˆà¸² DB_HOST à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´ à¸–à¹‰à¸²à¸ˆà¸³à¹€à¸›à¹‡à¸™
                                    # sed -i "s/DB_HOST=127.0.0.1/DB_HOST=db/g" .env
                                fi

                                # --- Step 3: à¸£à¸±à¸™ Docker Compose ---
                                echo "ðŸ³ Restarting Containers..."
                                
                                # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸¡à¸µ docker-compose V1 à¸«à¸£à¸·à¸­ V2
                                if command -v docker-compose &> /dev/null; then
                                    docker-compose down || true
                                    docker-compose up -d --build
                                else
                                    docker compose down || true
                                    docker compose up -d --build
                                fi
                                
                                echo "âœ… Deployment Success!"
                            '
                        """
                    }
                }
            }
        }
    }
}
