pipeline {
    agent any

    // กำหนดตัวแปร Environment (ถ้ามี)
    environment {
        IMAGE_NAME = "my-php-app"
    }

    stages {
        // -----------------------------
        // Stage 1: เตรียม Code
        // -----------------------------
        stage('Checkout Code') {
            steps {
                echo 'Step 1: Pulling code from Git...'
                checkout scm
            }
        }

        // -----------------------------
        // Stage 2: สร้าง Image (Build)
        // -----------------------------
        stage('Build Image') {
            steps {
                script {
                    echo 'Step 2: Building Docker Image...'
                    // สั่ง Build อย่างเดียว ยังไม่รัน
                    // --no-cache เพื่อให้มั่นใจว่าโค้ดใหม่ถูกใส่เข้าไปจริงๆ
                    sh "docker-compose build --no-cache"
                }
            }
        }

        // -----------------------------
        // Stage 3: นำขึ้นใช้งาน (Deploy)
        // -----------------------------
        stage('Deploy Container') {
            steps {
                script {
                    echo 'Step 3: Deploying Container...'
                    
                    // 1. เคลียร์ Container เก่าออกก่อน (เพื่อความสะอาด)
                    sh "docker-compose down || true"
                    
                    // 2. รัน Container ขึ้นมา (โดยใช้ Image ที่ Build ไว้แล้วจาก Stage ก่อนหน้า)
                    sh "docker-compose up -d"
                }
            }
        }
        
        // -----------------------------
        // Stage 4: ตรวจสอบผลลัพธ์ (Smoke Test)
        // -----------------------------
        stage('Health Check') {
            steps {
                script {
                    echo 'Step 4: Checking if service is alive...'
                    sleep 5
                    // เช็คว่า Container สถานะ Up อยู่ไหม
                    sh "docker-compose ps | grep Up"
                }
            }
        }
    }
}